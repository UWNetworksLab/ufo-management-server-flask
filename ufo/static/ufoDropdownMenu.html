<link rel="import" href="bower_components/iron-ajax/iron-ajax.html" />
<link rel="import" href="bower_components/iron-form/iron-form.html" />
<link rel="import" href="bower_components/iron-icons/iron-icons.html" />
<link rel="import" href="bower_components/paper-button/paper-button.html" />
<link rel="import" href="bower_components/paper-dialog/paper-dialog.html" />
<link rel="import" href="bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html" />
<link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html" />
<link rel="import" href="bower_components/paper-input/paper-input.html" />
<link rel="import" href="bower_components/paper-item/paper-item.html" />
<link rel="import" href="bower_components/paper-listbox/paper-listbox.html" />
<link rel="import" href="bower_components/paper-menu/paper-menu.html" />
<link rel="import" href="bower_components/paper-spinner/paper-spinner.html" />

<dom-module id="ufo-dropdown-menu">
  <style is="custom-style">
    .dropdown-icon {
      width: 20px;
      --iron-icon-fill-color: #009788;
    }
    .floatToTheRight {
      float: right;
    }
    paper-icon-item {
      cursor: pointer;
    }
    #removeAdminDialog {
      font-size: 16px;
    }
  </style>
  <template>
    <template is="dom-if" if="{{loading}}">
      <paper-spinner id="dropdownMenuSpinner" class="fixedPositionSpinner" active$={{loading}}></paper-spinner>
    </template>
    <iron-ajax auto
      url="{{resources.listAdminUrl}}"
      method="GET"
      handle-as="json"
      id="getAdminsAjax"
      loading="{{loading}}"
      last-response="{{ajaxResponse}}">
    </iron-ajax>

    <paper-dialog class="dropdown-content" id="ufoDropdownMenu" with-backdrop>
      <paper-button class="floatToTheRight" on-tap="exitAll">
        <iron-icon icon="close" item-icon></iron-icon>
      </paper-button>
      <paper-listbox>
        <paper-icon-item class="dropdown-button" id="addAdminButton" on-tap="flipToAddAdminFlow">
          <iron-icon class="dropdown-icon" src="{{resources.addIconUrl}}" item-icon></iron-icon>
          {{resources.addAdminText}}
        </paper-icon-item>
        <paper-icon-item class="dropdown-button" id="removeAdminButton" on-tap="flipToRemoveAdminFlow">
          <iron-icon class="dropdown-icon" icon="close" item-icon></iron-icon>
          {{resources.removeAdminText}}
        </paper-icon-item>
        <a href="{{resources.settingsUrl}}" id="settingsAnchor">
          <paper-icon-item class="dropdown-button">
            <iron-icon class="dropdown-icon" icon="settings" item-icon></iron-icon>
            {{resources.settingsText}}
          </paper-icon-item>
        </a>
        <paper-item class="dropdown-button">
          <form id="logoutForm" method="post" action="{{resources.logoutUrl}}">
            <input type="hidden" name="_xsrf_token" value="{{getXsrfToken()}}" />
            <paper-button type="submit" on-tap="submitLogoutForm">
              <strong>{{resources.logoutText}}</strong>
            </paper-button>
          </form>
        </paper-item>
      </paper-listbox>
    </paper-dialog>

    <paper-dialog id="addAdminDialog" with-backdrop>
      <paper-button on-tap="flipToDropdownFlowFromAddAdmin">
        <iron-icon icon="arrow-back" item-icon></iron-icon>
      </paper-button>
      <paper-button class="floatToTheRight" on-tap="exitAll">
        <iron-icon icon="close" item-icon></iron-icon>
      </paper-button>
      <template is="dom-if" if="{{showResponseStatus}}">
        <p id="addAdminResponseStatus">{{responseStatus}}</p>
      </template>
      <form is="iron-form" id="addAdminForm" method="post" action="{{resources.addAdminUrl}}" on-iron-form-response="parseAddAdminResponse" on-iron-form-presubmit="enableSpinner">
        <paper-input label="{{resources.adminUsernameLabel}}" id="paperAdminUsername" name="paperUsername"></paper-input>
        <paper-input label="{{resources.adminPasswordlabel}}" id="paperAdminPassword" name="paperPassword"></paper-input>
        <input type="hidden" name="admin_username" id="jsonUsername" value="" />
        <input type="hidden" name="admin_password" id="jsonPassword" value="" />
        <input type="hidden" name="_xsrf_token" value="{{getXsrfToken()}}" />
        <paper-button on-tap="submitAddAdminForm" class="floatToTheRight anchor-button" id="adminFormSubmitButton" type="submit">
          <strong>{{resources.addAdminSubmitText}}</strong>
        </paper-button>
      </form>
      <p></p>
      <br>
      <p></p>
    </paper-dialog>

    <paper-dialog id="removeAdminDialog" with-backdrop>
      <paper-button on-tap="flipToDropdownFlowFromRemoveAdmin" class="header">
        <iron-icon icon="arrow-back" item-icon></iron-icon>
      </paper-button>
      {{resources.removeAdminInstructions}}
      <paper-button class="floatToTheRight" on-tap="exitAll">
        <iron-icon icon="close" item-icon></iron-icon>
      </paper-button>
      <paper-dialog-scrollable>
        <form is="iron-form" id="removeAdminForm" method="post" action="{{resources.removeAdminUrl}}" on-iron-form-response="parseRemoveAdminResponse" on-iron-form-presubmit="enableSpinner">
          <paper-menu selected="{{selected}}" id="menuOfAdmins">
            <template is="dom-if" if="[[!hasMoreThanOne(ajaxResponse.items)]]">
              <template is="dom-repeat" items="[[ajaxResponse.items]]">
                <paper-item id="{{item.id}}" class="horizontal layout" disabled>
                  <strong>{{item.username}}</strong>
                </paper-item>
              </template>
            </template>
            <template is="dom-if" if="[[hasMoreThanOne(ajaxResponse.items)]]">
              <template is="dom-repeat" items="[[ajaxResponse.items]]">
                <paper-item id="{{item.id}}" class="horizontal layout">
                  <strong>{{item.username}}</strong>
                </paper-item>
              </template>
            </template>
          </paper-menu>
          <input type="hidden" id="hiddenAdminId" name="admin_id" value="">
          <input type="hidden" name="_xsrf_token" value="{{getXsrfToken()}}">
        </form>
      </paper-dialog-scrollable>
      <div class="buttons">
        <paper-button on-tap="submitRemoveAdminForm" class="anchor-button" id="removeAdminSubmitButton" type="submit"><strong>{{resources.removeAdminSubmitText}}</strong></paper-button>
      </div>
    </paper-dialog>

    <!-- TODO(eholder): Figure out how to style the UI so that the dialog
    appears in the correct place. Below are some alternative methods that
    present the same basic UI flow. These did not work because of stacking, as
    in they ended up being rendered underneath other elements and z-index did
    not fix the issue. If I can figure out how to fix that, we can use one of
    approach below, so they are kept around for now. I will clean this up once
    we have some feedback on the UI. -->

    <!-- Paper menu button approach.
    <paper-menu-button horizontal-align="right">
      <paper-button class="dropdown-trigger" id="openMenuButton">
       {{username}} <iron-icon icon="arrow-drop-down"></iron-icon>
      </paper-button>
      <paper-menu class="dropdown-content" id="ufoDropdownMenu">
        <paper-icon-item class="dropdown-button">
          <iron-icon class="dropdown-icon" src="{{resources.addIconUrl}}" item-icon></iron-icon>
          Add an Admin
        </paper-icon-item>
        <paper-icon-item class="dropdown-button">
          <iron-icon class="dropdown-icon" icon="settings" item-icon></iron-icon>
          Settings
        </paper-icon-item>
        <paper-item class="dropdown-button">
          Log Out
        </paper-item>
      </paper-menu>
    </paper-menu-button> -->


    <!-- Paper dropdown menu approach.
    <paper-dropdown-menu label="{{session['username']}}" id="username-and-menu" class="custom-dropdown flex">
      <paper-listbox class="dropdown-content">
        <paper-icon-item class="dropdown-button">
          <iron-icon class="dropdown-icon" src="{{url_for('static', filename='img/add-users.svg')}}" item-icon></iron-icon>
          Add an Admin
        </paper-icon-item>
        <paper-icon-item class="dropdown-button">
          <iron-icon class="dropdown-icon" icon="settings" item-icon></iron-icon>
          Settings
        </paper-icon-item>
        <paper-item class="dropdown-button">
          Log Out
        </paper-item>
      </paper-listbox>
    </paper-dropdown-menu>-->
  </template>

  <script>
    Polymer({
      is: 'ufo-dropdown-menu',
      properties: {
        resources: {
          type: Object,
          notify: true,
        },
        loading: {
          type: Boolean,
          value: false,
          notify: true,
        },
        ajaxResponse: {
          type: Object,
          notify: true,
        },
        showResponseStatus: {
          type: Boolean,
          notify: true,
          value: false,
        },
        responseStatus: {
          type: String,
          notify: true,
        },
        selected: {
          type: Number,
        },
      },
      listeners: {
        'iron-form-error': 'handleFormError',
      },
      getXsrfToken: function() {
        return document.getElementById('globalXsrf').value;
      },
      openMenu: function() {
        this.$.ufoDropdownMenu.open();
      },
      closeMenu: function() {
        this.$.ufoDropdownMenu.close();
      },
      flipToAddAdminFlow: function(e, details) {
        this.closeMenu();
        this.openAddAdminDialog();
      },
      flipToRemoveAdminFlow: function(e, details) {
        this.closeMenu();
        this.openRemoveAdminDialog();
      },
      submitLogoutForm: function(e, details) {
        this.querySelector('#logoutForm').submit();
      },
      openAddAdminDialog: function() {
        this.$.addAdminDialog.open();
      },
      openRemoveAdminDialog: function() {
        this.$.removeAdminDialog.open();
      },
      closeAdminDialog: function() {
        this.set('loading', false);  // Disables the spinner.

        var addAdminDialog = document.getElementById('addAdminDialog');
        if (addAdminDialog) {
          this.$.addAdminDialog.close();
        }

        var removeAdminDialog = document.getElementById('removeAdminDialog');
        if (removeAdminDialog) {
          this.$.removeAdminDialog.close();
        }
      },
      handleFormError: function(event, detail) {
        var errorDetail = {'detail': detail.request.xhr.response};
        var errorEvent = new CustomEvent('ApplicationError', errorDetail);
        document.getElementById('error-notification').dispatchEvent(errorEvent);
        this.closeAdminDialog();
      },
      flipToDropdownFlowFromAddAdmin: function(e, details) {
        this.openMenu();
        this.closeAdminDialog();
        this.resetAddAdminForm();
        this.set('showResponseStatus', false);
        this.set('responseStatus', '');
      },
      flipToDropdownFlowFromRemoveAdmin: function(e, details) {
        this.openMenu();
        this.closeAdminDialog();
        this.resetRemoveAdminForm();
      },
      enableSpinner: function() {
        this.set('loading', true);
      },
      makeAdminJson: function() {
        var username = this.querySelector('#paperAdminUsername').value;
        var password = this.querySelector('#paperAdminPassword').value;
        var jsonUsername = this.querySelector('#jsonUsername');
        var jsonPassword = this.querySelector('#jsonPassword');
        jsonUsername.value = JSON.stringify(username);
        jsonPassword.value = JSON.stringify(password);
      },
      makeAdminIdJson: function() {
        var adminId = this.$.menuOfAdmins.selectedItem.id;
        var adminIdInput = this.querySelector('#hiddenAdminId');
        adminIdInput.value = JSON.stringify(adminId);
      },
      getAdminsAgain: function() {
        this.$.getAdminsAjax.generateRequest();
      },
      submitAddAdminForm: function() {
        this.enableSpinner();
        this.makeAdminJson();
        this.querySelector('#addAdminForm').submit();
      },
      submitRemoveAdminForm: function() {
        if (this.$.menuOfAdmins.selectedItem) {
          this.enableSpinner();
          this.makeAdminIdJson();
          this.querySelector('#removeAdminForm').submit();
        }
      },
      parseAddAdminResponse: function(e, details) {
        var username = this.querySelector('#paperAdminUsername').value;
        var admins = details.xhr.response.items;
        if (admins) {
          var found = this._findUsernameInAdminList(admins, username);
          if (found) {
            this.set('showResponseStatus', true);
            this.set('responseStatus', this.resources.adminAddSuccessText);
            this.set('ajaxResponse', details.xhr.response);
            this.resetAddAdminForm();
          } else {
            this.set('showResponseStatus', true);
            this.set('responseStatus', this.resources.adminAddFailureText);
          }
        } else {
          this.set('showResponseStatus', true);
          this.set('responseStatus', this.resources.adminListGetError);
        }
        this.set('loading', false);
      },
      parseRemoveAdminResponse: function(e, details) {
        this.set('ajaxResponse', details.xhr.response);
        this.set('loading', false);
        this.resetRemoveAdminForm();
      },
      resetAddAdminForm: function() {
        this.querySelector('#addAdminForm').reset();
      },
      resetRemoveAdminForm: function() {
        this.querySelector('#removeAdminForm').reset();
      },
      hasMoreThanOne: function(items) {
        if (items) {
          return items.length > 1;
        }
        return false;
      },
      exitAll: function(e, details) {
        this.closeMenu();
        this.closeAdminDialog();
      },
      _findUsernameInAdminList: function(admins, username) {
        var found = false;
        var i = 0;
        for (; i < admins.length; ++i) {
          if (admins[i].username === username) {
            found = true;
            break;
          }
        }
        return found;
      },
    });
  </script>
</dom-module>
