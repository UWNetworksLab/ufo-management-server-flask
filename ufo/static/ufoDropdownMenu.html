<link rel="import" href="bower_components/iron-ajax/iron-ajax.html" />
<link rel="import" href="bower_components/iron-form/iron-form.html" />
<link rel="import" href="bower_components/iron-icons/iron-icons.html" />
<link rel="import" href="bower_components/paper-button/paper-button.html" />
<link rel="import" href="bower_components/paper-dialog/paper-dialog.html" />
<link rel="import" href="bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html" />
<link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html" />
<link rel="import" href="bower_components/paper-input/paper-input.html" />
<link rel="import" href="bower_components/paper-item/paper-item.html" />
<link rel="import" href="bower_components/paper-listbox/paper-listbox.html" />
<link rel="import" href="bower_components/paper-menu/paper-menu.html" />
<link rel="import" href="bower_components/paper-spinner/paper-spinner.html" />

<dom-module id="ufo-dropdown-menu">
  <style is="custom-style">
    .dropdown-icon {
      width: 20px;
      --iron-icon-fill-color: #009788;
    }
    .floatToTheRight {
      float: right;
    }
    paper-icon-item {
      cursor: pointer;
    }
    #removeAdminDialog {
      font-size: 16px;
    }
    #logoutButton {
      min-width: 0px;
      margin: 0px;
      padding: 0px;
    }
    .adminDialog {
      min-width: 350px;
    }
  </style>
  <template>
    <template is="dom-if" if="{{loading}}">
      <paper-spinner id="dropdownMenuSpinner" class="fixedPositionSpinner" active$={{loading}}></paper-spinner>
    </template>
    <iron-ajax auto
      url="{{resources.listAdminUrl}}"
      method="GET"
      handle-as="json"
      id="getAdminsAjax"
      loading="{{loading}}"
      last-response="{{ajaxResponse}}"
      json-prefix="{{resources.jsonPrefix}}">
    </iron-ajax>

    <paper-dialog class="dropdown-content adminDialog" id="ufoDropdownMenu" with-backdrop>
      <paper-button class="floatToTheRight" on-tap="exitAll">
        <iron-icon icon="close" item-icon></iron-icon>
      </paper-button>
      <paper-listbox>
        <paper-icon-item class="dropdown-button" id="addAdminButton" on-tap="flipToAddAdminFlow">
          <iron-icon class="dropdown-icon" src="{{resources.userAddIconUrl}}" item-icon></iron-icon>
          <strong>{{resources.addAdminText}}</strong>
        </paper-icon-item>
        <paper-icon-item class="dropdown-button" id="changeAdminPasswordButton" on-tap="flipToChangeAdminPasswordFlow">
          <iron-icon class="dropdown-icon" icon="editor:mode-edit" item-icon></iron-icon>
          <strong>{{resources.changeAdminPasswordText}}</strong>
        </paper-icon-item>
        <paper-icon-item class="dropdown-button" id="removeAdminButton" on-tap="flipToRemoveAdminFlow">
          <iron-icon class="dropdown-icon" icon="remove-circle-outline" item-icon></iron-icon>
          <strong>{{resources.removeAdminText}}</strong>
        </paper-icon-item>
        <a href="{{resources.settingsUrl}}" id="settingsAnchor">
          <paper-icon-item class="dropdown-button">
            <iron-icon class="dropdown-icon" icon="settings" item-icon></iron-icon>
            <strong>{{resources.settingsText}}</strong>
          </paper-icon-item>
        </a>
        <paper-icon-item class="dropdown-button">
          <iron-icon class="dropdown-icon" icon="subdirectory-arrow-right" item-icon></iron-icon>
          <form id="logoutForm" method="post" action="{{resources.logoutUrl}}">
            <input type="hidden" name="_xsrf_token" value="{{xsrfToken}}" />
            <paper-button type="submit" on-tap="submitLogoutForm" id="logoutButton">
              <strong>{{resources.logoutText}}</strong>
            </paper-button>
          </form>
        </paper-icon-item>
      </paper-listbox>
    </paper-dialog>

    <paper-dialog id="addAdminDialog" with-backdrop class="adminDialog">
      <paper-button on-tap="flipToDropdownFlowFromAddAdmin">
        <iron-icon icon="arrow-back" item-icon></iron-icon>
      </paper-button>
      <paper-button class="floatToTheRight" on-tap="exitAll">
        <iron-icon icon="close" item-icon></iron-icon>
      </paper-button>
      <template is="dom-if" if="{{showResponseStatus}}">
        <p id="addAdminResponseStatus">{{responseStatus}}</p>
      </template>
      <form is="iron-form" id="addAdminForm" method="post" action="{{resources.addAdminUrl}}" on-iron-form-response="parseAddAdminResponse" on-iron-form-presubmit="enableSpinner">
        <paper-input label="{{resources.adminEmailLabel}}" id="paperAdminEmail" name="paperEmail" required pattern="{{resources.regexes.emailValidationPattern}}" error-message="{{resources.regexes.emailValidationError}}" on-keypress="submitIfEnter"></paper-input>
        <paper-input label="{{resources.adminPasswordlabel}}" id="paperAdminPassword" name="paperPassword" required on-keypress="submitIfEnter"></paper-input>
        <input type="hidden" name="admin_email" id="jsonEmail" value="" />
        <input type="hidden" name="admin_password" id="jsonPassword" value="" />
        <input type="hidden" name="_xsrf_token" value="{{xsrfToken}}" />
        <paper-button on-tap="submitAddAdminForm" class="floatToTheRight anchor-button" id="adminFormSubmitButton" type="submit">
          <strong>{{resources.addAdminSubmitText}}</strong>
        </paper-button>
      </form>
      <p></p>
      <br>
      <p></p>
    </paper-dialog>

    <paper-dialog id="changeAdminPasswordDialog" with-backdrop class="adminDialog">
      <paper-button on-tap="flipToDropdownFlowFromChangeAdminPassword" class="header">
        <iron-icon icon="arrow-back" item-icon></iron-icon>
      </paper-button>
      {{resources.changeAdminPasswordInstructions}}
      <paper-button class="floatToTheRight" on-tap="exitAll">
        <iron-icon icon="close" item-icon></iron-icon>
      </paper-button>
      <form is="iron-form" id="changeAdminPasswordForm" method="post" action="{{resources.changeAdminPasswordUrl}}" on-iron-form-response="parseChangeAdminPasswordResponse" on-iron-form-presubmit="enableSpinner">
        <paper-input label="{{resources.changeAdminPasswordOldLabel}}" id="paperAdminOldPassword" name="paperAdminOldPassword" required on-keypress="submitIfEnter"></paper-input>
        <paper-input label="{{resources.changeAdminPasswordNewLabel}}" id="paperAdminNewPassword" name="paperAdminNewPassword" required on-keypress="submitIfEnter"></paper-input>
        <input type="hidden" name="old_password" id="jsonOldPassword" value="" />
        <input type="hidden" name="new_password" id="jsonNewPassword" value="" />
        <input type="hidden" name="_xsrf_token" value="{{xsrfToken}}">
      </form>
      <div class="buttons">
        <paper-button on-tap="submitChangeAdminPasswordForm" class="anchor-button" id="changeAdminPasswordSubmitButton" type="submit"><strong>{{resources.changeAdminPasswordSubmitText}}</strong></paper-button>
      </div>
    </paper-dialog>

    <paper-dialog id="removeAdminDialog" with-backdrop class="adminDialog">
      <paper-button on-tap="flipToDropdownFlowFromRemoveAdmin" class="header">
        <iron-icon icon="arrow-back" item-icon></iron-icon>
      </paper-button>
      {{resources.removeAdminInstructions}}
      <paper-button class="floatToTheRight" on-tap="exitAll">
        <iron-icon icon="close" item-icon></iron-icon>
      </paper-button>
      <paper-dialog-scrollable>
        <form is="iron-form" id="removeAdminForm" method="post" action="{{resources.removeAdminUrl}}" on-iron-form-response="parseRemoveAdminResponse" on-iron-form-presubmit="enableSpinner">
          <paper-menu selected="{{selected}}" id="menuOfAdmins">
            <template is="dom-if" if="[[!hasMoreThanOne(ajaxResponse.items)]]">
              <template is="dom-repeat" items="[[ajaxResponse.items]]">
                <paper-item id="{{item.id}}" class="horizontal layout" disabled>
                  <strong>{{item.email}}</strong>
                </paper-item>
              </template>
            </template>
            <template is="dom-if" if="[[hasMoreThanOne(ajaxResponse.items)]]">
              <template is="dom-repeat" items="[[ajaxResponse.items]]">
                <paper-item id="{{item.id}}" class="horizontal layout">
                  <strong>{{item.email}}</strong>
                </paper-item>
              </template>
            </template>
          </paper-menu>
          <input type="hidden" id="hiddenAdminId" name="admin_id" value="">
          <input type="hidden" name="_xsrf_token" value="{{xsrfToken}}">
        </form>
      </paper-dialog-scrollable>
      <div class="buttons">
        <paper-button on-tap="submitRemoveAdminForm" class="anchor-button" id="removeAdminSubmitButton" type="submit"><strong>{{resources.removeAdminSubmitText}}</strong></paper-button>
      </div>
    </paper-dialog>
  </template>

  <script>
    Polymer({
      is: 'ufo-dropdown-menu',
      properties: {
        resources: {
          type: Object,
          notify: true,
        },
        loading: {
          type: Boolean,
          value: false,
          notify: true,
        },
        ajaxResponse: {
          type: Object,
          notify: true,
        },
        showResponseStatus: {
          type: Boolean,
          notify: true,
          value: false,
        },
        responseStatus: {
          type: String,
          notify: true,
        },
        selected: {
          type: Number,
        },
      },
      listeners: {
        'iron-form-error': 'handleFormError',
      },
      ready: function() {
        this.$.addAdminForm.request.handleAs = "json";
        this.$.addAdminForm.request.jsonPrefix = this.resources.jsonPrefix;
        this.$.changeAdminPasswordForm.request.handleAs = "json";
        this.$.changeAdminPasswordForm.request.jsonPrefix = this.resources.jsonPrefix;
        this.$.removeAdminForm.request.handleAs = "json";
        this.$.removeAdminForm.request.jsonPrefix = this.resources.jsonPrefix;
        var xsrfElement = document.getElementById('globalXsrf');
        if (xsrfElement) {
          this.xsrfToken = .value;
        }
      },
      openMenu: function() {
        this.$.ufoDropdownMenu.open();
      },
      closeMenu: function() {
        this.$.ufoDropdownMenu.close();
      },
      flipToAddAdminFlow: function(e, details) {
        this.closeMenu();
        this.openAddAdminDialog();
      },
      flipToChangeAdminPasswordFlow: function(e, details) {
        this.closeMenu();
        this.openChangeAdminPasswordDialog();
      },
      flipToRemoveAdminFlow: function(e, details) {
        this.closeMenu();
        this.openRemoveAdminDialog();
      },
      submitLogoutForm: function(e, details) {
        this.querySelector('#logoutForm').submit();
      },
      openAddAdminDialog: function() {
        this.$.addAdminDialog.open();
      },
      openChangeAdminPasswordDialog: function() {
        this.$.changeAdminPasswordDialog.open();
      },
      openRemoveAdminDialog: function() {
        this.$.removeAdminDialog.open();
      },
      closeAdminDialog: function() {
        this.set('loading', false);  // Disables the spinner.

        var addAdminDialog = document.getElementById('addAdminDialog');
        if (addAdminDialog) {
          this.$.addAdminDialog.close();
        }

        var changeAdminPasswordDialog = document.getElementById('changeAdminPasswordDialog');
        if (changeAdminPasswordDialog) {
          this.$.changeAdminPasswordDialog.close();
        }

        var removeAdminDialog = document.getElementById('removeAdminDialog');
        if (removeAdminDialog) {
          this.$.removeAdminDialog.close();
        }
      },
      handleFormError: function(event, detail) {
        event.stopPropagation();
        var fixedJsonText = detail.request.xhr.response;
        var prefixIndex = fixedJsonText.indexOf(this.resources.jsonPrefix);
        if (prefixIndex >= 0) {
          var position = prefixIndex + this.resources.jsonPrefix.length;
          fixedJsonText = fixedJsonText.substring(position);
        }
        var jsonObj = JSON.parse(fixedJsonText);
        var errorDetail = {'detail': jsonObj};
        var errorEvent = new CustomEvent('ApplicationError', errorDetail);
        document.getElementById('error-notification').dispatchEvent(errorEvent);
        this.closeAdminDialog();
      },
      flipToDropdownFlowFromAddAdmin: function(e, details) {
        this.openMenu();
        this.closeAdminDialog();
        this.resetAddAdminForm();
        this.set('showResponseStatus', false);
        this.set('responseStatus', '');
      },
      flipToDropdownFlowFromChangeAdminPassword: function(e, details) {
        this.openMenu();
        this.closeAdminDialog();
        this.resetChangeAdminPasswordForm();
      },
      flipToDropdownFlowFromRemoveAdmin: function(e, details) {
        this.openMenu();
        this.closeAdminDialog();
        this.resetRemoveAdminForm();
      },
      enableSpinner: function() {
        this.set('loading', true);
      },
      makeAdminJson: function() {
        var email = this.querySelector('#paperAdminEmail').value;
        var password = this.querySelector('#paperAdminPassword').value;
        var jsonEmail = this.querySelector('#jsonEmail');
        var jsonPassword = this.querySelector('#jsonPassword');
        jsonEmail.value = JSON.stringify(email);
        jsonPassword.value = JSON.stringify(password);
      },
      makeAdminPasswordsJson: function() {
        var oldPassword = this.querySelector('#paperAdminOldPassword').value;
        var newPassword = this.querySelector('#paperAdminNewPassword').value;
        var jsonOldPassword = this.querySelector('#jsonOldPassword');
        var jsonNewPassword = this.querySelector('#jsonNewPassword');
        jsonOldPassword.value = JSON.stringify(oldPassword);
        jsonNewPassword.value = JSON.stringify(newPassword);
      },
      makeAdminIdJson: function() {
        var adminId = this.$.menuOfAdmins.selectedItem.id;
        var adminIdInput = this.querySelector('#hiddenAdminId');
        adminIdInput.value = JSON.stringify(adminId);
      },
      getAdminsAgain: function() {
        this.$.getAdminsAjax.generateRequest();
      },
      submitAddAdminForm: function() {
        this.enableSpinner();
        this.makeAdminJson();
        this.querySelector('#addAdminForm').submit();
      },
      submitChangeAdminPasswordForm: function() {
        this.enableSpinner();
        this.makeAdminPasswordsJson();
        this.querySelector('#changeAdminPasswordForm').submit();
      },
      submitRemoveAdminForm: function() {
        if (this.$.menuOfAdmins.selectedItem) {
          this.enableSpinner();
          this.makeAdminIdJson();
          this.querySelector('#removeAdminForm').submit();
        }
      },
      parseAddAdminResponse: function(e, details) {
        var email = this.querySelector('#paperAdminEmail').value;
        var admins = this.$.addAdminForm.request.lastResponse.items;
        if (admins) {
          var found = this._findEmailInAdminList(admins, email);
          if (found) {
            this.set('showResponseStatus', true);
            this.set('responseStatus', this.resources.adminAddSuccessText);
            this.set('ajaxResponse', this.$.addAdminForm.request.lastResponse);
            this.resetAddAdminForm();
          } else {
            this.set('showResponseStatus', true);
            this.set('responseStatus', this.resources.adminAddFailureText);
          }
        } else {
          this.set('showResponseStatus', true);
          this.set('responseStatus', this.resources.adminListGetError);
        }
        this.set('loading', false);
      },
      parseChangeAdminPasswordResponse: function(e, details) {
        this.set('ajaxResponse', this.$.changeAdminPasswordForm.request.lastResponse);
        this.set('loading', false);
        this.resetChangeAdminPasswordForm();
      },
      parseRemoveAdminResponse: function(e, details) {
        this.set('ajaxResponse', this.$.removeAdminForm.request.lastResponse);
        this.set('loading', false);
        this.resetRemoveAdminForm();
      },
      resetAddAdminForm: function() {
        this.querySelector('#addAdminForm').reset();
      },
      resetChangeAdminPasswordForm: function() {
        this.querySelector('#changeAdminPasswordForm').reset();
      },
      resetRemoveAdminForm: function() {
        this.querySelector('#removeAdminForm').reset();
      },
      hasMoreThanOne: function(items) {
        if (items) {
          return items.length > 1;
        }
        return false;
      },
      exitAll: function(e, details) {
        this.closeMenu();
        this.closeAdminDialog();
      },
      _findEmailInAdminList: function(admins, email) {
        var found = false;
        var i = 0;
        for (; i < admins.length; ++i) {
          if (admins[i].email === email) {
            found = true;
            break;
          }
        }
        return found;
      },
      submitIfEnter: function(e) {
        if (e.keyCode === 13) {
          this.submitAddAdminForm();
        }
      },
    });
  </script>
</dom-module>
