<link rel="import" href="bower_components/iron-form/iron-form.html" />
<link rel="import" href="bower_components/paper-button/paper-button.html" />
<link rel="import" href="bower_components/paper-checkbox/paper-checkbox.html" />
<link rel="import" href="bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html" />
<link rel="import" href="bower_components/paper-item/paper-item.html" />
<link rel="import" href="bower_components/paper-listbox/paper-listbox.html" />
<link rel="import" href="bower_components/paper-spinner/paper-spinner.html" />

<dom-module id="user-add-form">
  <style is="custom-style">
    paper-listbox {
      background: #EEE;
    }
    .addTopMargin {
      margin-top: 12px;
    }
  </style>
  <template>
    <div>
      <template is="dom-if" if="{{loading}}">
        <paper-spinner id="spinner" class="absolutePositionSpinner" active$={{loading}}></paper-spinner>
      </template>
      <template is="dom-if" if="{{showInputFields}}">
        <form is="iron-form" id="{{addFlowTextObj.id}}" method="get" action="{{resources.addUrl}}" on-iron-form-response="parseGetResponse" on-iron-form-presubmit="enableSpinnerAndSetPrefixes">
          <template is="dom-if" if="[[!idMatches(addFlowTextObj.id, 'domainAdd')]]">
            <paper-input label="{{addFlowTextObj.label1}}" type="textbox" name="{{addFlowTextObj.name1}}" pattern="{{resources.regexes.keyLookupPattern}}" error-message="{{resources.regexes.keyLookupError}}"></paper-input>
            <br>
            <p>{{addFlowTextObj.definition1}}</p>
            <br>
          </template>
          <template is="dom-if" if="[[idMatches(addFlowTextObj.id, 'domainAdd')]]">
            <input type="hidden" name="get_all" value="true">
          </template>
          <paper-button on-tap="submitGetForm" class="form-submit-button anchor-button" type="submit"><strong>{{addFlowTextObj.searchButton}}</strong></paper-button>
        </form>
      </template>
      <template is="dom-if" if="{{!showInputFields}}">
        <template is="dom-if" if="{{shouldDisplayWithDialog}}">
          <paper-dialog-scrollable>
            <form is="iron-form" id="addPostForm" method="post" action="{{resources.addUrl}}" on-iron-form-response="parsePostResponse" on-iron-form-presubmit="enableSpinner">
              <paper-listbox>
              <template is="dom-if" if="[[!areAnyUsersFound()]]">
                <paper-item id="noResultsItem" class="horizontal layout">
                  <span class="flex"><strong>{{resources.addFlowNoResults}}</strong></span>
                </paper-item>
              </template>
                <template is="dom-repeat" items="[[lastResponse.directory_users]]">
                  <paper-item id="{{item.name}}" class="horizontal layout">
                    <paper-checkbox name="checkboxes" value="{{item}}"></paper-checkbox>
                    <span class="flex"><strong>{{item.name}}</strong></span>
                    <span>{{item.email}}</span>
                  </paper-item>
                </template>
              </paper-listbox>
              <input type="hidden" id="hiddenUsers" name="users" value="{{usersJson}}">
              <input type="hidden" name="_xsrf_token" value="{{getXsrfToken()}}">
            </form>
          </paper-dialog-scrollable>
          <set-scrollable-dialog-to-modal></set-scrollable-dialog-to-modal>
        </template>
        <template is="dom-if" if="{{!shouldDisplayWithDialog}}">
          <form is="iron-form" id="addPostForm" method="post" action="{{resources.addUrl}}" on-iron-form-response="parsePostResponse" on-iron-form-presubmit="enableSpinner">
            <paper-listbox>
              <template is="dom-if" if="[[!areAnyUsersFound()]]">
                <paper-item id="noResultsItem" class="horizontal layout">
                  <span class="flex"><strong>{{resources.addFlowNoResults}}</strong></span>
                </paper-item>
              </template>
              <template is="dom-repeat" items="[[lastResponse.directory_users]]">
                <paper-item id="{{item.name}}" class="horizontal layout">
                  <paper-checkbox name="checkboxes" value="{{item}}"></paper-checkbox>
                  <span class="flex"><strong>{{item.name}}</strong></span>
                  <span>{{item.email}}</span>
                </paper-item>
              </template>
            </paper-listbox>
            <br>
            <input type="hidden" id="hiddenUsers" name="users" value="{{usersJson}}">
            <input type="hidden" name="_xsrf_token" value="{{getXsrfToken()}}">
          </form>
        </template>
        <paper-button on-tap="resetForms" class="anchor-button addTopMargin"><strong>{{resources.lookAgainText}}</strong></paper-button>
      </template>
    </div>
    <div class="buttons">
      <paper-button class="anchor-button" dialog-dismiss on-tap="resetForms">
      <strong>{{resources.dismissText}}</strong>
      </paper-button>
      <paper-button class="anchor-button" autofocus on-tap="submitPostForm">
      <strong>{{addFlowTextObj.saveButton}}</strong>
      </paper-button>
    </div>
  </template>

  <script>
    Polymer({
      is: 'user-add-form',
      properties: {
        resources: {
          type: Object,
        },
        addFlowTextObj: {
          type: Object,
        },
        showInputFields: {
          type: Boolean,
          value: true,
          notify: true,
        },
        lastResponse: {
          type: Object,
          notify: true,
        },
        selectedUsers: {
          type: Array,
          notify: true,
          value: [],
        },
        usersJson: {
          type: String,
          notify: true,
        },
        loading: {
          type: Boolean,
          value: false,
          notify: true,
        },
        shouldDisplayWithDialog: {
          type: Boolean,
          value: false,
          notify: true,
        },
      },
      listeners: {
        'iron-form-error': 'handleFormError',
      },
      setJsonPrefixes: function() {
        var addForm = document.getElementById(this.addFlowTextObj.id);
        addForm.request.handleAs = "json";
        addForm.request.jsonPrefix = this.resources.jsonPrefix;
      },
      enableSpinner: function() {
        this.set('loading', true);
      },
      enableSpinnerAndSetPrefixes: function() {
        this.setJsonPrefixes();
        this.enableSpinner();
      },
      submitGetForm: function() {
        this.querySelector('#' + this.addFlowTextObj.id).submit();
      },
      submitPostForm: function() {
        this.querySelector('#addPostForm').request.handleAs = "json";
        this.querySelector('#addPostForm').request.jsonPrefix = this.resources.jsonPrefix;
        this.setSelectedUsersFromCheckboxes();
        this.querySelector('#addPostForm').submit();
      },
      parseGetResponse: function(e, detail) {
        this.set('lastResponse', e.target.request.lastResponse);
        this.set('showInputFields', false);
        this.set('loading', false);
      },
      closeModal: function() {
        this.set('loading', false);
        var userModal = document.getElementById('userModal');
        if (userModal) {
          userModal.close();
        }
      },
      parsePostResponse: function(e, detail) {
        this.sendUsersJsonToList(e.target.request.lastResponse);
        this.resetForms();
        this.closeModal();
      },
      handleFormError: function(event, detail) {
        event.stopPropagation();
        var fixedJsonText = detail.request.xhr.response;
        var prefixIndex = fixedJsonText.indexOf(this.resources.jsonPrefix);
        if (prefixIndex >= 0) {
          var position = prefixIndex + this.resources.jsonPrefix.length;
          fixedJsonText = fixedJsonText.substring(position);
        }
        var jsonObj = JSON.parse(fixedJsonText);
        var errorDetail = {'detail': jsonObj};
        var errorEvent = new CustomEvent('ApplicationError', errorDetail);
        document.getElementById('error-notification').dispatchEvent(errorEvent);
        this.closeModal();
      },
      resetForms: function(e, detail) {
        this.set('showInputFields', true);
        document.getElementById(this.addFlowTextObj.id).reset();
        var addPostForm = this.querySelector('#addPostForm');
        if (addPostForm) {
          addPostForm.reset();
        }
        this.set('selectedUsers', []);
        this.set('usersJson', '');
      },
      sendUsersJsonToList: function(updatedUsersJson) {
        var listElem = document.getElementById(this.resources.listId);
        if (listElem) {
          listElem.setAjaxResponse(updatedUsersJson);
        }
      },
      idMatches: function(id, string1) {
        return id === string1;
      },
      getXsrfToken: function() {
        return document.getElementById('globalXsrf').value;
      },
      updateCheckedUsers: function(e) {
        var checkboxElem = event.path[0];
        if (checkboxElem.checked) {
          this.selectedUsers.push(checkboxElem.value);
        } else {
          var index = this.selectedUsers.indexOf(checkboxElem.value);
          if (index != -1) {
            this.selectedUsers.splice(index, 1);
          }
        }
        this.usersJson = JSON.stringify(this.selectedUsers);
      },
      setSelectedUsersFromCheckboxes: function() {
        this.selectedUsers = [];
        var checkboxes = this.querySelectorAll('paper-checkbox');
        for (var i in checkboxes) {
          if (checkboxes[i].checked) {
            this.selectedUsers.push(checkboxes[i].value);
          }
        }
        var jsonUsers = JSON.stringify(this.selectedUsers);
        this.set('usersJson', jsonUsers);
        var formElem = document.getElementById('addPostForm');
        var input = formElem.querySelector('#hiddenUsers');
        input.value = jsonUsers;
      },
      areAnyUsersFound: function() {
        return this.lastResponse.directory_users.length > 0;
      },
    });
  </script>
</dom-module>
